<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DVDS Availability</title>
  <style>
    :root{--bg:#0b1320;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--brand:#34b16a;--edge:#263042}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto}
    .wrap{max-width:1100px;margin:48px auto;padding:0 20px}
    .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);padding:24px}
    h1{margin:0 0 16px;font-size:26px} p{margin:0 0 12px;color:var(--muted)}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--edge);background:#0f172a;color:var(--ink)}
    button{background:var(--brand);border:none;color:#052814;font-weight:700;cursor:pointer}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(3,1fr)}
    .grid2{display:grid;gap:12px;grid-template-columns:repeat(2,1fr)}
    @media (max-width:880px){.grid{grid-template-columns:1fr}.grid2{grid-template-columns:1fr}}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    .slots{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));margin-top:16px}
    .slot{background:#0a1222;border:1px solid var(--edge);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .slot b{font-size:15px}
    .small{font-size:13px;color:var(--muted)}
    pre{background:#0a1222;border-radius:12px;padding:14px;white-space:pre-wrap;word-break:break-word}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#0a1222;border:1px solid var(--edge);font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>DVDS Availability (Production)</h1>
    <p>Choose account, calendar, date, and appointment type. Then fetch live slots.</p>
    <div class="grid">
      <div>
        <label>Account</label>
        <select id="account">
          <option value="main">Main</option>
          <option value="parents">Parents</option>
        </select>
      </div>
      <div>
        <label>Appointment Type ID</label>
        <input id="appt" placeholder="e.g. 50529778" value="50529778" />
      </div>
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Find by Location (name contains)</label>
        <input id="location" placeholder="e.g. Scottsdale or Tempe" />
        <div class="small">Optional if you pick a calendar below.</div>
      </div>
      <div>
        <label>Calendar</label>
        <select id="calendar"></select>
      </div>
    </div>
    <div class="row">
      <button id="load">Load calendars</button>
      <button id="check">Fetch availability</button>
      <span id="meta" class="badge">waiting…</span>
    </div>
    <div id="slots" class="slots"></div>
    <pre id="debug" style="display:none"></pre>
  </div>
</div>
<script>
const $ = id => document.getElementById(id);
const meta=$('meta'), slots=$('slots'), dbg=$('debug');

// default today's date in America/Phoenix
(function setToday(){const tz='America/Phoenix'; const d=new Date().toLocaleDateString('en-CA',{timeZone:tz}); $('date').value=d;})();

function fmtLocal(iso){try{const dt = new Date(iso); return dt.toLocaleString([], {hour:'numeric', minute:'2-digit'})}catch{ return iso }}
function clearSlots(){ slots.innerHTML=''; }
function showError(msg){ clearSlots(); const d=document.createElement('div'); d.className='small'; d.textContent=msg; slots.appendChild(d); }

meta.onclick = () => {
  if (!dbg.textContent) return;
  const next = dbg.style.display === 'block' ? 'none' : 'block';
  dbg.style.display = next;
};

$('load').onclick = async () => {
  meta.textContent = 'Loading calendars…';
  clearSlots();
  dbg.textContent = '';
  dbg.style.display = 'none';
  const account = $('account').value;
  try {
    const r = await fetch(`/api/calendars?account=${encodeURIComponent(account)}`);
    const j = await r.json();
    if (!j.ok) throw new Error(j.error || 'Failed to load calendars');
    const sel = $('calendar'); sel.innerHTML='';
    (j.calendars || []).forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = `${c.name} (#${c.id})`;
      sel.appendChild(opt);
    });
    meta.textContent = `Loaded ${j.calendars?.length || 0} calendars for ${j.account}`;
  } catch(e){ meta.textContent='Error'; showError(e.message || String(e)); }
};

$('check').onclick = async () => {
  meta.textContent = 'Fetching times…';
  clearSlots();
  const account=$('account').value;
  const appt=$('appt').value.trim();
  const date=$('date').value;
  const loc=$('location').value.trim();
  const cal=$('calendar').value;
  const p = new URLSearchParams({ account, appointmentTypeId: appt, date });
  if (cal) p.set('calendarID', cal); else if (loc) p.set('location', loc);
  try{
    const r = await fetch(`/api/availability?`+p.toString());
    const j = await r.json();
    dbg.textContent = JSON.stringify(j, null, 2);
    dbg.style.display = '';
    if (!j.ok) { meta.textContent='Error'; return showError(j.error || 'No data'); }
    meta.textContent = `Found ${j.count ?? (Array.isArray(j.times)?j.times.length:0)} slots`;
    if (Array.isArray(j.times) && j.times.length){
      j.times.forEach(t => {
        // Acuity returns { time: "2025-10-24T15:30:00-07:00", slots: 1, ... }
        const el = document.createElement('div'); el.className='slot';
        const btn = document.createElement('button'); btn.textContent='Copy time';
        btn.onclick = () => navigator.clipboard.writeText(t.time || JSON.stringify(t));
        el.innerHTML = `<b>${fmtLocal(t.time || t.datetime || 'time')}</b><div class="small">slots: ${t.slots ?? '?'}</div>`;
        el.appendChild(btn); slots.appendChild(el);
      });
    } else { showError('No slots for that date/selection'); }
  }catch(e){ meta.textContent='Error'; showError(e.message || String(e)); }
};
</script>
</body></html>
