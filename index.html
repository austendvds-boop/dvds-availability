<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DVDS Availability</title>
<style>
  :root{--bg:#0b1320;--panel:#111827;--ink:#e5e7eb;--muted:#94a3b8;--brand:#34b16a;--edge:#263042}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:36px auto;padding:0 16px;display:flex;flex-direction:column;gap:18px}
  .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);padding:20px}
  h1{margin:0 0 12px;font-size:26px}
  h2{margin:0 0 10px;font-size:20px}
  label{display:block;margin:10px 0 6px;color:var(--muted)}
  select,input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--edge);background:#0f172a;color:var(--ink)}
  button{background:var(--brand);border:none;color:#052814;font-weight:700;cursor:pointer}
  button[disabled]{opacity:.45;cursor:not-allowed}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
  @media (max-width:560px){.grid{grid-template-columns:1fr}}
  .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#0a1222;border:1px solid var(--edge);font-size:12px;color:var(--muted)}
  .slots{display:grid;gap:10px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));margin-top:12px}
  .slot{background:#0a1222;border:1px solid var(--edge);border-radius:12px;padding:12px}
  .small{font-size:13px;color:var(--muted)}
  #calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
  .cal-head{font-size:13px;color:var(--muted);text-align:center}
  .cal-cell{border:1px solid var(--edge);border-radius:12px;padding:10px;background:#0f172a;color:inherit}
  .cal-day{font-weight:700;margin-bottom:4px}
  .cal-count{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>DVDS Availability (pooled by location)</h1>
    <div class="grid">
      <div>
        <label>Account</label>
        <select id="account">
          <option value="main">Main</option>
          <option value="parents">Parents</option>
        </select>
      </div>
      <div>
        <label>Location</label>
        <select id="location"></select>
      </div>
      <div>
        <label>Date</label>
        <input id="date" type="date" />
      </div>
      <div>
        <label>Days (1–7)</label>
        <select id="days">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7" selected>7</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button id="fetch">Fetch pooled availability</button>
      <span id="meta" class="badge">waiting…</span>
    </div>
    <div id="hint" class="small" style="margin-top:6px"></div>
    <div id="note" class="small" style="margin-top:6px"></div>
    <div id="slots" class="slots"></div>
  </div>

  <div class="card">
    <h2>Monthly availability</h2>
    <div class="row">
      <button id="prev">◀ Prev</button>
      <span id="calLabel" class="badge">Month</span>
      <button id="next">Next ▶</button>
    </div>
    <div id="calGrid"></div>
    <div id="calMsg" class="small" style="margin-top:8px"></div>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
const meta = $('meta');
const hint = $('hint');
const note = $('note');
const slots = $('slots');
const calGrid = $('calGrid');
const calLabel = $('calLabel');
const calMsg = $('calMsg');

const tz = 'America/Phoenix';
$('date').value = new Date().toLocaleDateString('en-CA', { timeZone: tz });

let locationLists = { main: [], parents: [] };
let currentTypeId = null;

const formatCity = (value) =>
  value.replace(/\b\w/g, (c) => c.toUpperCase());

const fetchJSON = async (url) => {
  const response = await fetch(url);
  const text = await response.text();
  let data = {};
  if (text) {
    try { data = JSON.parse(text); } catch { data = {}; }
  }
  if (!response.ok) {
    const error = new Error(data.error || response.statusText || 'Request failed');
    error.data = data;
    error.status = response.status;
    throw error;
  }
  return data;
};

async function loadLocationLists() {
  const [main, parents] = await Promise.all([
    fetchJSON('/api/resolve-city?list=1&account=main'),
    fetchJSON('/api/resolve-city?list=1&account=parents')
  ]);
  locationLists = {
    main: main.cities || [],
    parents: parents.cities || []
  };
  renderLocations(undefined, $('account').value);
}

function renderLocations(selectedLocation, preferredAccount) {
  const select = $('location');
  select.innerHTML = '';
  const accounts = [
    { key: 'main', label: 'Main account' },
    { key: 'parents', label: 'Parents account' }
  ];
  let firstValue = null;
  let firstValuePreferred = false;
  for (const { key, label } of accounts) {
    const cities = locationLists[key];
    if (!cities || !cities.length) continue;
    const group = document.createElement('optgroup');
    group.label = label;
    cities.forEach((city) => {
      const option = document.createElement('option');
      option.value = city;
      option.dataset.account = key;
      option.textContent = formatCity(city);
      if (!firstValue || (preferredAccount && !firstValuePreferred && key === preferredAccount)) {
        firstValue = city;
        firstValuePreferred = key === preferredAccount;
      }
      if (selectedLocation && selectedLocation === city) {
        option.selected = true;
      }
      group.appendChild(option);
    });
    select.appendChild(group);
  }
  if (!select.value && firstValue) {
    select.value = firstValue;
  }
  syncAccountWithLocation();
}

function syncAccountWithLocation() {
  const locOption = $('location').selectedOptions[0];
  if (!locOption) return;
  const account = locOption.dataset.account || 'main';
  $('account').value = account;
}

async function resolveSetup() {
  const account = $('account').value;
  const locOption = $('location').selectedOptions[0];
  if (!locOption) {
    hint.textContent = 'No locations configured';
    $('fetch').disabled = true;
    return;
  }
  const location = locOption.value;

  try {
    const cityInfo = await fetchJSON(`/api/resolve-city?account=${account}&location=${encodeURIComponent(location)}`);
    currentTypeId = cityInfo.typeId || null;
  } catch (error) {
    hint.textContent = error.data?.error || error.message;
    $('fetch').disabled = true;
    return;
  }

  try {
    const params = new URLSearchParams({ account, location });
    if (currentTypeId) params.set('appointmentTypeId', currentTypeId);
    const res = await fetchJSON(`/api/resolve-location?${params}`);
    const configured = res.configuredIds?.join(', ') || '—';
    const allowed = res.typeCalendarIds?.join(', ') || '—';
    const finalIds = res.intersection?.join(', ') || '—';
    hint.textContent = `Configured IDs: ${configured} · Type-allowed: ${allowed} · Final IDs: ${finalIds}`;
    $('fetch').disabled = !res.intersection || !res.intersection.length;
  } catch (error) {
    const data = error.data || {};
    hint.textContent = data.error || error.message;
    $('fetch').disabled = true;
  }

  note.textContent = currentTypeId
    ? `Using appointment type ${currentTypeId} for ${formatCity(location)}.`
    : 'No appointment type configured for this location. Update city-types.json.';
}

$('account').addEventListener('change', async () => {
  renderLocations(undefined, $('account').value);
  syncAccountWithLocation();
  await resolveSetup();
  await loadMonth();
});

$('location').addEventListener('change', async () => {
  syncAccountWithLocation();
  await resolveSetup();
  await loadMonth();
});

$('days').addEventListener('change', () => {});

const fmtTime = (iso) => {
  try {
    return new Date(iso).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
  } catch {
    return iso;
  }
};

$('fetch').onclick = async () => {
  meta.textContent = 'Loading…';
  slots.innerHTML = '';
  const account = $('account').value;
  const location = $('location').value;
  const date = $('date').value;
  const days = $('days').value;
  const params = new URLSearchParams({ account, location, date, days });
  if (currentTypeId) params.set('appointmentTypeId', currentTypeId);

  try {
    const data = await fetchJSON(`/api/location-availability?${params}`);
    const totalTimes = data.results?.reduce((sum, day) => sum + (day.times?.length || 0), 0) || 0;
    meta.textContent = `Merged ${totalTimes} slots across ${data.pooledCalendarIDs?.length || 0} calendar(s)`;
    if (!data.results || !data.results.length) {
      slots.innerHTML = '<div class="small">No slots for this selection.</div>';
      return;
    }
    const firstDay = data.results[0];
    if (!firstDay.times || !firstDay.times.length) {
      slots.innerHTML = '<div class="small">No slots for this selection.</div>';
      return;
    }
    slots.innerHTML = firstDay.times.map((entry) => `
      <div class="slot">
        <div><strong>${fmtTime(entry.time)}</strong></div>
        <div class="small">pooled slots: ${entry.slots || 0}</div>
      </div>
    `).join('');
  } catch (error) {
    const msg = error.data?.error || error.message;
    meta.textContent = 'Error';
    slots.innerHTML = `<div class="small">${msg}</div>`;
  }
};

let currentMonthISO = (() => {
  const today = new Date().toLocaleDateString('en-CA', { timeZone: tz });
  return today.slice(0, 7) + '-01';
})();

const monthLabel = (ymd) => {
  const dt = new Date(ymd + 'T00:00:00');
  return dt.toLocaleDateString([], { month: 'long', year: 'numeric' });
};

const shiftMonth = (ymd, delta) => {
  const dt = new Date(ymd + 'T00:00:00');
  dt.setMonth(dt.getMonth() + delta);
  const year = dt.getFullYear();
  const month = String(dt.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}-01`;
};

async function loadMonth() {
  const account = $('account').value;
  const locOption = $('location').selectedOptions[0];
  if (!locOption) {
    calGrid.innerHTML = '<div class="small">Configure locations to view the calendar.</div>';
    return;
  }
  const location = locOption.value;
  const params = new URLSearchParams({ account, location, date: currentMonthISO });
  if (currentTypeId) params.set('appointmentTypeId', currentTypeId);

  calLabel.textContent = monthLabel(currentMonthISO);
  calGrid.innerHTML = '<div class="small" style="grid-column:1/-1">Loading…</div>';
  calMsg.textContent = '';

  try {
    const data = await fetchJSON(`/api/month-availability?${params}`);
    const headers = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    calGrid.innerHTML = headers.map((h) => `<div class="cal-head">${h}</div>`).join('');

    const dt = new Date(currentMonthISO + 'T00:00:00');
    const first = new Date(dt.getFullYear(), dt.getMonth(), 1);
    for (let i = 0; i < first.getDay(); i += 1) {
      calGrid.insertAdjacentHTML('beforeend', '<div class="cal-cell" style="opacity:.2"></div>');
    }

    for (let day = 1; day <= data.days; day += 1) {
      const y = first.getFullYear();
      const m = String(first.getMonth() + 1).padStart(2, '0');
      const d = String(day).padStart(2, '0');
      const ymd = `${y}-${m}-${d}`;
      const count = data.byDate?.[ymd] || 0;
      const cell = document.createElement('button');
      cell.className = 'cal-cell';
      cell.innerHTML = `<div class="cal-day">${day}</div><div class="cal-count">${count} slots</div>`;
      cell.onclick = async () => {
        $('date').value = ymd;
        const qs = new URLSearchParams({ account, location, date: ymd, days: '1' });
        if (currentTypeId) qs.set('appointmentTypeId', currentTypeId);
        try {
          const dayData = await fetchJSON(`/api/location-availability?${qs}`);
          const times = dayData.results?.[0]?.times || [];
          if (!times.length) {
            calMsg.textContent = `No times for ${ymd}`;
            slots.innerHTML = '';
            return;
          }
          calMsg.textContent = `Times for ${ymd}`;
          slots.innerHTML = times.map((entry) => `
            <div class="slot">
              <div><strong>${fmtTime(entry.time)}</strong></div>
              <div class="small">pooled slots: ${entry.slots || 0}</div>
            </div>
          `).join('');
          window.scrollTo({ top: document.querySelector('.wrap').offsetTop, behavior: 'smooth' });
        } catch (error) {
          const msg = error.data?.error || error.message;
          calMsg.textContent = msg;
        }
      };
      calGrid.appendChild(cell);
    }
  } catch (error) {
    calGrid.innerHTML = `<div class="small" style="grid-column:1/-1">${error.data?.error || error.message}</div>`;
  }
}

$('prev').onclick = () => { currentMonthISO = shiftMonth(currentMonthISO, -1); loadMonth(); };
$('next').onclick = () => { currentMonthISO = shiftMonth(currentMonthISO, 1); loadMonth(); };

(async function init() {
  try {
    await loadLocationLists();
    await resolveSetup();
    await loadMonth();
  } catch (error) {
    hint.textContent = error.message;
    $('fetch').disabled = true;
  }
})();
</script>
</body>
</html>
